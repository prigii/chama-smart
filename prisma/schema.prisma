datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

enum UserRole {
  ADMIN
  MEMBER
  TREASURER
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
  EXPENSE
  FINE
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  PAID
  DEFAULTED
}

enum IntegrationType {
  MPESA
  PAYSTACK
  KCB
  EQUITY
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  phone         String?   // Important for M-Pesa integration
  avatarUrl     String?
  role          UserRole  @default(MEMBER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  transactions  Transaction[]
  loans         Loan[]          @relation("Borrower")
  guarantees    LoanGuarantor[]
  
  // Chama Relation
  chamaId       String?
  chama         Chama?    @relation(fields: [chamaId], references: [id])
}

model Chama {
  id            String        @id @default(cuid())
  name          String
  email         String        @unique
  phone         String?
  users         User[]
  assets        Asset[]
  integrations  Integration[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Integration {
  id          String          @id @default(cuid())
  type        IntegrationType
  name        String?         // Optional display name
  config      Json            // Keys: consumerKey, consumerSecret, passkey, secretKey, etc.
  isEnabled   Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  chamaId     String
  chama       Chama           @relation(fields: [chamaId], references: [id])
}

model TransactionAlert {
  id              String   @id @default(cuid())
  externalId      String?  @unique // M-Pesa Receipt Number, Paystack Ref
  provider        IntegrationType
  amount          Decimal  @db.Decimal(10, 2)
  payload         Json     // Raw webhook data
  status          String   @default("PENDING") // PENDING, PROCESSED, FAILED
  createdAt       DateTime @default(now())
}

model Transaction {
  id              String          @id @default(cuid())
  amount          Decimal         @db.Decimal(10, 2)
  type            TransactionType
  description     String?
  referenceCode   String?         // M-Pesa Code
  date            DateTime        @default(now())
  
  // Relations
  userId          String
  user            User            @relation(fields: [userId], references: [id])
}

model Loan {
  id              String      @id @default(cuid())
  amount          Decimal     @db.Decimal(10, 2)
  interestRate    Decimal     // e.g., 10 for 10%
  durationMonths  Int
  totalRepayable  Decimal     @db.Decimal(10, 2)
  balance         Decimal     @db.Decimal(10, 2)
  status          LoanStatus  @default(PENDING)
  dueDate         DateTime?
  createdAt       DateTime    @default(now())

  // Relations
  borrowerId      String
  borrower        User            @relation("Borrower", fields: [borrowerId], references: [id])
  guarantors      LoanGuarantor[]
}

model LoanGuarantor {
  id        String   @id @default(cuid())
  amount    Decimal  @db.Decimal(10, 2) // Amount guaranteed
  accepted  Boolean  @default(false)
  
  // Relations
  loanId    String
  loan      Loan     @relation(fields: [loanId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@unique([loanId, userId])
}

model Asset {
  id            String   @id @default(cuid())
  name          String
  description   String?
  purchaseDate  DateTime
  purchasePrice Decimal  @db.Decimal(12, 2)
  currentValue  Decimal  @db.Decimal(12, 2)
  category      String
  documents     String[]
  
  // Relations
  chamaId       String?
  chama         Chama?   @relation(fields: [chamaId], references: [id])
}
