datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  MEMBER
  TREASURER
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  LOAN_DISBURSEMENT
  LOAN_REPAYMENT
  EXPENSE
  FINE
}

enum LoanStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  PAID
  DEFAULTED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  phone         String?   // Important for M-Pesa integration
  avatarUrl     String?
  role          UserRole  @default(MEMBER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  transactions  Transaction[]
  loans         Loan[]          @relation("Borrower")
  guarantees    LoanGuarantor[]
}

model Transaction {
  id              String          @id @default(cuid())
  amount          Decimal         @db.Decimal(10, 2)
  type            TransactionType
  description     String?
  referenceCode   String?         // M-Pesa Code
  date            DateTime        @default(now())
  
  // Relations
  userId          String
  user            User            @relation(fields: [userId], references: [id])
}

model Loan {
  id              String      @id @default(cuid())
  amount          Decimal     @db.Decimal(10, 2)
  interestRate    Decimal     // e.g., 10 for 10%
  durationMonths  Int
  totalRepayable  Decimal     @db.Decimal(10, 2)
  balance         Decimal     @db.Decimal(10, 2)
  status          LoanStatus  @default(PENDING)
  dueDate         DateTime?
  createdAt       DateTime    @default(now())

  // Relations
  borrowerId      String
  borrower        User            @relation("Borrower", fields: [borrowerId], references: [id])
  guarantors      LoanGuarantor[]
}

model LoanGuarantor {
  id        String   @id @default(cuid())
  amount    Decimal  @db.Decimal(10, 2) // Amount guaranteed
  accepted  Boolean  @default(false)
  
  // Relations
  loanId    String
  loan      Loan     @relation(fields: [loanId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])

  @@unique([loanId, userId])
}

model Asset {
  id            String   @id @default(cuid())
  name          String
  description   String?
  purchaseDate  DateTime
  purchasePrice Decimal  @db.Decimal(12, 2)
  currentValue  Decimal  @db.Decimal(12, 2)
  category      String   // e.g., Land, Equity, Bonds
  documents     String[] // URLs from UploadThing
}
